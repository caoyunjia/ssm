<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>及时雨-金融机构-融资受理查询-查看</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <link rel="stylesheet" href="js/plugin/kkpager_green.css"/>
    <link href="css/new.css?v=APP_VER" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-datetimepicker.min.js"></script>
    <script src="js/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="js/common.js?v=APP_VER"></script>
    <script src="js/plugin/kkpager.min.js"></script>
    <script src="js/plugin/jquery.validate.js"></script>
    <script src="js/plugin/validate-extend.js"></script>
</head>
<body>
<div class="container m-content">
    <form class="form-horizontal row" action="#" id="formId">
        <div class="row form-group">
            <div class="col-xs-6">
                <label class="col-md-4 control-label">申请编号</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" readonly="readonly" id="sqbh" name="sqbh" placeholder="">
                </div>
            </div>
            <div class="col-xs-6">
                <label class="col-md-4 control-label">融资金额(元)</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" data-type="currency" readonly="readonly" id="rzje" name="rzje" placeholder="">
                </div>
            </div>
        </div>
        <div class="row form-group">
            <div class="col-xs-6">
                <label class="col-md-4 control-label">受理编号</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" readonly="readonly" id="slbh" name="slbh" placeholder="">
                </div>
            </div>
            <div class="col-xs-6">
                <label for="CLRQ" class="col-sm-4 control-label">申请日期</label>
                <div class="col-md-8">
                    <input class="form-control" size="16" type="text" id="sqrq" name="sqrq" readonly="readonly"/>
                </div>
            </div>
        </div>
        <div class="row form-group">
            <div class="col-xs-6">
                <label for="CLRQ" class="col-sm-4 control-label">贸易起始日期</label>
                <div class="col-md-8">
                    <input class="form-control" size="16" type="text" id="myqsrq" name="myqsrq" readonly="readonly"/>
                    <input type="hidden" id="dtp_input3" value="" />
                </div>
            </div>
            <div class="col-xs-6">
                <label for="CLRQ" class="col-sm-4 control-label">贸易结束日期</label>
                <div class="col-md-8">
                    <input class="form-control" size="16" type="text" id="myjsrq" name="myjsrq" readonly="readonly" />
                    <input type="hidden" id="dtp_input3" value="" />
                </div>
            </div>
        </div>
        <div class="row form-group">
            <div class="col-xs-6">
                <label class="col-md-4 control-label">融资币别</label>
                <div class="col-md-8">
                    <select class="form-control" dic-type="B1056" dic-blank=" " id="rzbb" name="rzbb" placeholder="" readonly disabled="disabled"></select>
                </div>
            </div>
            <div class="col-xs-6">
                <label class="col-md-4 control-label">贸易业务编号</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="myywbh" name="myywbh" placeholder="" readonly="readonly">
                </div>
            </div>
        </div>
        <div class="row form-group">
            <div class="col-xs-6">
                <label class="col-md-4 control-label">贸易业务类型</label>
                <div class="col-md-8">
                    <select class="form-control" dic-type="B1059" dic-blank=" " id="myywlx" name="myywlx" placeholder="" readonly disabled="disabled"></select>
                </div>
            </div>
            <div class="col-xs-6">
                <label class="col-md-4 control-label">贸易业务金额(元)</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="myywje" data-type="currency" name="myywje" placeholder="" readonly="readonly">
                </div>
            </div>
        </div>
        <div class="row form-group">
            <div class="col-xs-6">
                <label class="col-md-4 control-label">贸易业务笔数</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="myywbs" name="myywbs" placeholder="" readonly="readonly">
                </div>
            </div>
            <div class="col-xs-6">
                <label class="col-md-4 control-label">贸易币别</label>
                <div class="col-md-8">
                    <select class="form-control" dic-type="B1056" dic-blank=" " id="mybb" name="mybb" placeholder="" readonly disabled="disabled"></select>
                </div>
            </div>
        </div>
        <div class="row form-group">
            <div class="col-xs-6">
                <label class="col-md-4 control-label">关联保理合同</label>
                <!--<div class="col-md-8">
                	<select class="form-control" name="xydm" id="glxybh" >
                	</select>
                </div>-->
                <!--Added-->
                 <div class="col-md-5" style="width:55%">
                	<input type="text" class="form-control" readonly="readonly" value="" id="glxybh" name="xydm"></div>
                <div class="col-md-1 control-label">
                    <button type="button" class="selectBtn" id="glblhtbu" maxlength="26"> </button></div>
                <!--/Added-->
            </div>
        </div>
        <div class="row form-group">
            <div class="col-xs-12">
				<label class="col-md-2 control-label">审批意见</label>
				<div class="col-md-10 pl10">
					<textarea type="textArea" class="form-control" placeholder="字数不能超过300字" maxlength="300" id="spyj" name="spyj" ></textarea>
				</div>
			</div>
        </div>
        <input type="hidden" id="cpms" name="cpms">
        <input type="hidden" id="id" name="id">
        <input type="hidden" id="yszkzrje" name="yszkzrje">
        <input type="hidden" id="qsrq" name="qsrq">
        <input type="hidden" id="dqrq" name="dqrq">
        
    </form>
    <div class="form-group" id="">
        <div class="search_result">
            <table class="table-bordered table"  id="yszkTable">
                <thead>
                <tr>
                    <th>发票号</th>
                    <th>发票代码</th>
                    <th>发票金额(元)</th>
                    <th>发票日期</th>
                    <th>税率</th>
                    <th>税额</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="kkpager"></div>
        </div>
    </div>
    <div class="row">
        <div class="text-center col-xs-12">
            <a  class="btn btn-default btn_query" onclick="spPass()">融资受理通过</a>
            <a  class="btn btn-default btn_query" onclick="spRefused()">融资受理不通过</a>
            <a  class="btn btn-default btn_query" href="javascript:void(0)" onclick="history.go(-1)">返回</a>
        </div>
    </div>
</div>


<!--Added-->
<div id="glblhtModal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"  aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="glblhtcss">
            <!--<div class=""> -->
                <form action="#" class="form form-horizontal" id="" style="padding-top:5px">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
			            <h4 style="padding-bottom:15px">请选择要关联的保理合同</h4>
                    <div class="search_result">
                        <table class="table table-bordered table-hover blhtTable" style="width:100%;white-space: nowrap;">
							<thead>
								<tr>
								    <th style="width:30px"></th>
									<!-- <th style="width:40px">序号</th> -->
									<th>保理合同代码</th>
									<th>保理合同编号</th>
									<th>核心企业</th>
									<th>融资客户</th>
									<th>保存时间</th>
									<th dic-type="B1043">状态</th>
								</tr>
							</thead>
							<tbody>
						</tbody>
						</table>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 text-center">
                            <a href="javascript:void(0)" class="btn btn_query" id="saveId">确认</a>
                            <a href="javascript:void(0)" class="btn btn_query " data-dismiss='modal'>返回</a>
                        </div>
                    </div>
                    <input type="hidden" id="hiddenid">
                </form>
            </div>
        </div>
    </div>
<!--/Added-->
<script>
    $(document).ready(function (){
        //初始化日期插件
        dataPiker();
        var slbh = locationObj.getParams().slbh;
        var khh = locationObj.getParams().khh;
        var hxkhh = locationObj.getParams().hxkhh;
        //获取融资基本信息
        requestObj.ajaxServer(
            requestObj.address.findRzslcxDetails,
            {"slbh": slbh,
             "pageSize":10,
       		 "pageIndex":1
       		 },
            function(data) {
                pluginObj.setFormValueByName(data.body.data[0]);
                $("#sqrq").val(formatDateStr(data.body.data[0].sqrq));
                $("#myqsrq").val(formatDateStr(data.body.data[0].myqsrq));
                $("#myjsrq").val(formatDateStr(data.body.data[0].myjsrq));
                $("#rzje").val(numberToCurrency(data.body.data[0].rzje));
                $("#myywje").val(numberToCurrency(data.body.data[0].myywje));
            }
        );
        $("#glblhtbu").click(function(){
            $("#glblhtModal").modal("show");
	        requestObj.ajaxServer(
	    	        requestObj.address.findBlhtList,
	    	        {
		    	        "pageSize":10,
		    		 	"pageIndex":1,
		    		 	"rzkhh":khh,
			           	"hxqykhh":hxkhh,
			           	"htzt":"02"
	    	        },
	    	        function successFun(data){
	    	        	requestObj.searchObj.totalPage = data.body.totalPageNo; //总页码
	    	    		requestObj.searchObj.recordsTotal = data.body.totalCount; //总记录数目
	    	    		requestObj.initPager(
	    	    			requestObj.address.findBlhtList,
	    	    			successFun
	    	    		);
	    	    		$(".blhtTable tbody").empty();
	    	    		var listVo = data.body.data;
	    	            for(var i = 0; i < listVo.length; i++){
	    	        	   $(".blhtTable tbody").append(
			        		  "<tr>" +
	          				 "<td><input type='radio' name='blht' value='"+ listVo[i].xydm +"'></td>" +
	                          "<td>" + listVo[i].xydm + "</td>" +
	                          "<td>" + listVo[i].xybh + "</td>" +
	                          "<td>" + listVo[i].hxqykhmc + "</td>" +
	                          "<td>" + listVo[i].rzkhmc + "</td>" +
	                          "<td>" + formatDateStr(listVo[i].crsj) + "</td>" +
	                          "<td>" + listVo[i].htzt+ "</td>" +
	                          "</tr>"
	    			       );
	    	             }
	    	             $("[name='blht']").eq(0).prop("checked","checked");
	    			}
	    	 );
        });
        $("#saveId").click(function(){
        	var _xydm=$("input[name='blht']:checked").val();
        	if(!_xydm){
        		pluginObj.alert("","请选择保理合同");
        		return;
            }
        	$("#glxybh").val(_xydm);
        	$("#glblhtModal").modal("hide");
        });
        $(".blhtTable tbody").on("click","tr",function(){
			$(this).find("[name='blht']").prop("checked","checked");
        });
      //获取保理合同
       /*  requestObj.ajaxServer(
        	requestObj.address.findBlhtList,
       		{"pageSize":10,
        	 "pageIndex":1,
        	 "rzkhh":khh,
        	 "hxqykhh":hxkhh,
        	 "htzt":"02"
           	},
        	function(data){
           		var listVO = data.body.data;
           		if(listVO){
           			for(var i = 0; i < listVO.length; i++){
                		$("#glxybh").append(
    						"<option value='"+listVO[i].xydm+"'>"+listVO[i].xydm+"</option>"
                        );
                    }
                }else{
                	pluginObj.alert("","请先补充保理合同信息");
                }
            	
            }
		); */
		//获取应收账款
        requestObj.ajaxServer(
    	        requestObj.address.findRzslyszk,
    	        {
    	        "pageSize":10,
    		 	"pageIndex":1,
    	        "slbh":slbh
    	        },
    	        function successFun(data){
    	        	requestObj.searchObj.totalPage = data.body.totalPageNo; //总页码
    	    		requestObj.searchObj.recordsTotal = data.body.totalCount; //总记录数目
    	    		requestObj.initPager(
    	    			requestObj.address.findRzslyszk,
    	    			successFun
    	    		);
    	    		$("#yszkTable tbody").empty();
    	            var listVo = data.body.data;
    	            for(var i = 0; i < listVo.length; i++){
    	        	   $("#yszkTable tbody").append(
    			        		  "<tr>" +
    	          				 "<td>" + listVo[i].fph + "</td>" +
    	                          "<td>" + listVo[i].fpdm + "</td>" +
    	                          "<td>" + numberToCurrency(listVo[i].fpje) + "</td>" +
    	                          "<td>" + formatDateStr8(listVo[i].kprq) + "</td>" +
    	                          "<td>" + noNull(listVo[i].sl)+ "</td>" +
    	                          "<td>" + numberToCurrency(listVo[i].se) + "</td>" +
    	                          "<td>"
    	                          +"<a href='jrjgrzslyszkcx.html?id="+ listVo[i].id +"' style='color: #0044CC;'>查看</a></td>" +
    	                          "</tr>"
    			       );
    	          }
    			}
    	 );
    });

    //审批通过函数
    function spPass(){
        $("#formId").submit(false);
        if(!$('#formId').valid()){
            return;
        }
       var xydm = $("#glxybh").val();
       if(!xydm){
    	   pluginObj.alert("","请选择关联保理合同");
    	   return;
       }
        requestObj.ajaxServer(//保理合同中的应收账款转让净额
            	requestObj.address.findOneblht,
           		{"pageSize":10,
            	 "pageIndex":1,
            	 "xydm":xydm
               	},
            	function(data){
					var yszkzrjeStr = data.body.yszkzrje;
					$("#cpms").val(data.body.cpms);
					$("#yszkzrje").val(data.body.yszkzrje);
					$("#qsrq").val(data.body.htrq);
					$("#dqrq").val(data.body.htdqr);
					if(!yszkzrjeStr){
						 pluginObj.alert("","没有查到应收账款转让金额");
					}   
					var yszkzrje = parseInt(yszkzrjeStr);
					var myywje = parseInt($("#myywje").val());
					if(yszkzrje != myywje){
						pluginObj.comfire("保理合同中应收账款转让净额为【"+numberToCurrency(yszkzrje)+"】元，该笔融资项下贸易业务金额为【"+numberToCurrency(myywje)+"】元，两者不相等，是否确认继续办理？",
								spPassFun,function(){});
					}else{
						spPassFun();
					}             	
                }
    		);
        
    }
	function spPassFun(){
	        requestObj.ajaxServer(
	            requestObj.address.jrjgRzslPass,
	            requestObj.packRequest(decodeURIComponent($("#formId").serialize(), true)),
	            function(data){
	                pluginObj.alert("","操作成功");
	                window.location.href = './jrjgrzsqcx.html?v=APP_VER';
	            }
	        )
	}
    
    //审批退回函数
    function spRefused(){
        var spyj = $("#spyj").val();
        var sqbh = $("#sqbh").val();
        var khh = locationObj.getParams().khh;
        var slbh = locationObj.getParams().slbh;
        pluginObj.comfire("确认该融资申请受理不通过？",function(){
        	  requestObj.ajaxServer(
        	            requestObj.address.jrjgRzslRefuse,
        	            {
        	                "sqbh" : sqbh,
        	                "spyj" : spyj,
        	                "khh" : khh,
        	                "slbh" : slbh
        	            },
        	            function(data){
        	                pluginObj.alert("","操作成功");
        	                window.location.href = './jrjgrzslcx.html?v=APP_VER';

        	            }
        	        )
        },function(){});
      
    };
    $("#formId").validate({
        rules : {
        	xydm: {
                required : true,
            },
            spyj: {
            	required : true
            }
        },
    });
    function noNull(sj){
		if(!sj){
			return "0.00";
		}
		return sj;
    }
</script>
</body>
</html>